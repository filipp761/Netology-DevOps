# Домашнее задание к занятию 12.8. «Резервное копирование баз данных»

## Задание 1. Резервное копирование

Кейс

Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Приведите ответ в свободной форме.
____
Ответ:

**1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день** 

Что-бы восстанавливать данные в полном объеме надо учитывать некорорые факторы, такие как нагрузка на базу в течение дня и наличие свободного места на диске.

Если в какое либо время дня нагрузка на базу незначительное и объем базы не большой, то можно расммотреть вариант ежедневного FULL BACKUP, в часы ниаименьшей нагрузки.

Если такого времени нет или обьем базы велик, то оптимальным вариантом будем дифференциальный бэкап.

Для восстановления файлов потребуется последний созданный бэкап и последний дифферницальный.

Скорость создания в разы выше чем у полного бэкапа.

**1.2. Необходимо восстанавливать данные за час до предполагаемой поломки** 

Для такого варианта восстановления подойдет инкрементый бэкап.

В нем начальная точка - полный бэкап. Затем инкрементый бэкап можно настроить так часто как нам это необходимо.

Настраиваем его выполнение раз в час и получаем возможность восстановления данных за последний час работы.

**1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.**

Репликация: Master - Slave

Только переключение произойдет не моментально, а когда балансировщик поймет, что мастер недоступен. А это должно быть прописано в настройках, какое время ожидания и ответа. 

## Задание 2. PostgreSQL
2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Приведите ответ в свободной форме.
____
Ответ:
### 2.1 С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

### pg_dump

pg_dump — выгрузить базу данных PostgreSQL в виде скрипта или в архивном формате

### Синтаксис**

pg_dump [параметр-подключения...] [параметр...] [имя_бд]

pg_dump — это программа для создания резервных копий базы данных PostgreSQL. Она создаёт целостные копии, даже если база параллельно используется. Программа pg_dump не препятствует доступу других пользователей к базе данных (ни для чтения, ни для записи).

pg_dump — это программа для создания резервных копий базы данных PostgreSQL. Она создаёт целостные копии, даже если база параллельно используется. Программа pg_dump не препятствует доступу других пользователей к базе данных (ни для чтения, ни для записи).

### Примеры

Выгрузка базы данных mydb в файл SQL-скрипта:
```
$ pg_dump mydb > db.sql
```
Восстановление из ранее полученного скрипта в чистую базу newdb:
```
$ psql -d newdb -f db.sql
```
Выгрузка базы данных в специальном формате:
```
$ pg_dump -Fc mydb > db.dump
```
Выгрузка базы данных в формате каталога:
```
$ pg_dump -Fd mydb -f dumpdir
```
Выгрузка базы данных в формате каталога в 5 параллельных потоков:
```
$ pg_dump -Fd mydb -j 5 -f dumpdir
```

### pg_restore
Восстановление из архива в чистую новую базу данных newdb:
```
$ pg_restore -d newdb db.dump
```
Восстановление архива в ту же базу данных, из которой он был выгружен, с предварительным удалением текущего содержимого этой базы данных:
```
$ pg_restore -d postgres --clean --create db.dump
```
Выгрузка отдельной таблицы mytab:
```
$ pg_dump -t mytab mydb > db.sql
```
Выгрузка всех таблиц, имена которых начинаются с emp и которые принадлежат схеме detroit, кроме таблицы employee_log:
```
$ pg_dump -t 'detroit.emp*' -T detroit.employee_log mydb > db.sql
```
Выгрузка всех схем, имена которых начинаются с east или west, заканчиваются на gsm и не содержат test:
```
$ pg_dump -n 'east*gsm' -n 'west*gsm' -N '*test*' mydb > db.sql
```
То же самое, но с использованием регулярного выражения:
```
$ pg_dump -n '(east|west)*gsm' -N '*test*' mydb > db.sql
```
Выгрузка всех объектов базы данных, кроме таблиц, имена которых начинаются с ts_:
```
$ pg_dump -T 'ts_*' mydb > db.sql
```
**Ссылка на официальную документацию:**

https://postgrespro.ru/docs/postgresql/15/app-pgdump

### 2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Возможна автоматизация за счет выполнения Bash-скриптов планировщиков заданий

**Вариант 1. Запуск от пользователя root; одна база.**
```
#!/bin/sh
PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin

PGPASSWORD=password
export PGPASSWORD
pathB=/backup
dbUser=dbuser
database=db

find $pathB \( -name "*-1[^5].*" -o -name "*-[023]?.*" \) -ctime +61 -delete
pg_dump -U $dbUser $database | gzip > $pathB/pgsql_$(date "+%Y-%m-%d").sql.gz

unset PGPASSWORD
```
* где password — пароль для подключения к postgresql; /backup — каталог, в котором будут храниться резервные копии; dbuser — имя учетной записи для подключения к БУБД; pathB — путь до каталога, где будут храниться резервные копии.
* данный скрипт сначала удалит все резервные копии, старше 61 дня, но оставит от 15-о числа как длительный архив. После при помощи утилиты pg_dump будет выполнено подключение и резервирование базы db. Пароль экспортируется в системную переменную на момент выполнения задачи.

Для запуска резервного копирования по расписанию, сохраняем скрипт в файл, например, /scripts/postgresql_dump.sh и создаем задание в планировщике:
```
crontab -e
3 0 * * * /scripts/postgresql_dump.sh
```
* наш скрипт будет запускаться каждый день в 03:00.

Ссылка на вариант автоматизации:

https://www.dmosk.ru/miniinstruktions.php?mini=postgresql-dump
## Задание 3. MySQL
3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

Приведите ответ в свободной форме.
____
Ответ:
### 3.1 С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.
С помощью XtraBackup
```
xtrabackup --backup --target-dir=/root/backupdb/inc1 --incremental-basedir=/root/backupdb/full
```
**Ссылки:**

https://habr.com/ru/company/first/blog/582230/
https://serveradmin.ru/polnyj-i-inkrementnyj-backup-mysql/

Задания, помеченные звёздочкой, — дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. 
Вы можете их выполнить, если хотите глубже шире разобраться в материале.


